{% extends "base.html" %}
{% block title %}Trades - Nightrader{% endblock %}
{% block head %}<meta http-equiv="refresh" content="10">{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-white">Trade History</h1>
  <button onclick="document.getElementById('import-modal').classList.toggle('hidden')"
    class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-md text-xs text-slate-300 border border-slate-700">
    Import CSV
  </button>
</div>

<!-- Import Modal -->
<div id="import-modal" class="hidden mb-6 bg-slate-900 border border-slate-700 rounded-lg p-4">
  <div class="text-sm text-slate-300 mb-2">Import trades from Kalshi CSV export</div>
  <div class="text-xs text-amber-400/80 mb-3">This will replace all existing trades and positions.</div>
  <form method="post" action="/trades/import" enctype="multipart/form-data" class="flex items-center gap-3">
    <input type="file" name="csv_file" accept=".csv"
      class="text-xs text-slate-400 file:mr-3 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:bg-slate-800 file:text-slate-300 hover:file:bg-slate-700">
    <button type="submit" class="px-4 py-1.5 bg-brand-600 hover:bg-brand-500 rounded-md text-xs text-white font-medium">Upload &amp; Import</button>
  </form>
</div>

{% if import_result == 'success' %}
<div class="mb-4 px-4 py-2 bg-emerald-900/30 border border-emerald-800/50 rounded-lg text-sm text-emerald-400">
  Imported {{ import_count }} trade{{ 's' if import_count != 1 }} from CSV.
</div>
{% elif import_result == 'error' %}
<div class="mb-4 px-4 py-2 bg-red-900/30 border border-red-800/50 rounded-lg text-sm text-red-400">
  Failed to import CSV. Check file format.
</div>
{% endif %}

<!-- Filters -->
<form method="get" class="flex flex-wrap gap-3 mb-6">
  <input type="text" name="ticker" value="{{ filter_ticker }}" placeholder="Filter by ticker..."
    class="bg-slate-900 border border-slate-700 rounded-md px-3 py-2 text-sm text-slate-300 placeholder-slate-600 focus:outline-none focus:border-brand-500 w-64">
  <select name="limit" class="bg-slate-900 border border-slate-700 rounded-md px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-brand-500">
    {% for n in [25, 50, 100, 200] %}
    <option value="{{ n }}" {{ 'selected' if filter_limit == n }}>{{ n }} trades</option>
    {% endfor %}
  </select>
  <button type="submit" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-md text-sm text-slate-300">Filter</button>
</form>

{% if trades %}
<div class="overflow-x-auto">
  <table class="w-full text-sm" id="trades-table">
    <thead>
      <tr class="border-b border-slate-800 text-left text-xs text-slate-500 uppercase tracking-wide">
        <th class="pb-3 pr-3 cursor-pointer hover:text-slate-300 select-none" data-sort="id">ID <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-3 cursor-pointer hover:text-slate-300 select-none" data-sort="time">Time <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-3 cursor-pointer hover:text-slate-300 select-none" data-sort="ticker">Ticker <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-3 cursor-pointer hover:text-slate-300 select-none" data-sort="action">Action <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-3 text-right cursor-pointer hover:text-slate-300 select-none" data-sort="qty">Qty <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-3 text-right cursor-pointer hover:text-slate-300 select-none" data-sort="price">Price <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-3 text-right cursor-pointer hover:text-slate-300 select-none" data-sort="fee">Fee <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-3 text-right cursor-pointer hover:text-slate-300 select-none" data-sort="fills">Fills <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-3 cursor-pointer hover:text-slate-300 select-none" data-sort="settlement">Settlement <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-3 cursor-pointer hover:text-slate-300 select-none" data-sort="opened">Opened <span class="sort-arrow"></span></th>
        <th class="pb-3 cursor-pointer hover:text-slate-300 select-none" data-sort="status">Status <span class="sort-arrow"></span></th>
      </tr>
    </thead>
    <tbody>
      {% for t in trades %}
      <tr class="border-b border-slate-800/50 hover:bg-slate-900/50 sort-row"
          data-id="{{ t.id }}"
          data-time="{{ t.created_at }}"
          data-ticker="{{ t.ticker|decode_ticker }}"
          data-action="{{ t.action }} {{ t.side }}"
          data-qty="{{ t.count }}"
          data-price="{{ t.price_cents }}"
          data-fee="{{ t.fee_cents|default(0) }}"
          data-fills="{{ t.fill_count }}"
          data-settlement="{{ t.settlement|default('') }}"
          data-opened="{{ t.position_opened_at|default('') }}"
          data-status="{{ t.status }}">
        <td class="py-2.5 pr-3 text-slate-500 text-xs">{{ t.id }}</td>
        <td class="py-2.5 pr-3 text-slate-400 text-xs font-mono">{{ t.created_at }}</td>
        <td class="py-2.5 pr-3">
          <div class="text-xs text-slate-200">{{ t.ticker|decode_ticker }}</div>
          <div class="text-[10px] font-mono text-slate-500 mt-0.5">{{ t.ticker }}</div>
        </td>
        <td class="py-2.5 pr-3">
          <span class="text-xs text-slate-300">{{ t.action|upper }} {{ t.side|upper }}</span>
        </td>
        <td class="py-2.5 pr-3 text-right text-slate-300">{{ t.count }}</td>
        <td class="py-2.5 pr-3 text-right text-slate-400">{{ t.price_cents }}c</td>
        <td class="py-2.5 pr-3 text-right text-amber-400/70">${{ "%.2f"|format((t.fee_cents|default(0)) / 100) }}</td>
        <td class="py-2.5 pr-3 text-right text-slate-400">{{ t.fill_count }}</td>
        <td class="py-2.5 pr-3">
          {% if t.settlement == 'won' %}
            <span class="px-2 py-0.5 rounded text-xs font-bold bg-emerald-900/50 text-emerald-400">{{ t.settlement_label }}</span>
          {% elif t.settlement == 'lost' %}
            <span class="px-2 py-0.5 rounded text-xs font-bold bg-red-900/50 text-red-400">{{ t.settlement_label }}</span>
          {% elif t.settlement == 'even' %}
            <span class="px-2 py-0.5 rounded text-xs font-medium bg-slate-800 text-slate-400">{{ t.settlement_label }}</span>
          {% elif t.settlement == 'pending' %}
            <span class="text-xs text-amber-400/70">{{ t.settlement_label }}</span>
          {% else %}
            <span class="text-xs text-slate-600">{{ t.settlement_label }}</span>
          {% endif %}
        </td>
        <td class="py-2.5 pr-3 text-slate-500 text-xs font-mono">{{ t.position_opened_at }}</td>
        <td class="py-2.5">
          {% if t.status == 'filled' %}
            <span class="px-2 py-0.5 rounded text-xs font-medium bg-emerald-900/50 text-emerald-400">filled</span>
          {% elif t.status == 'partial' %}
            <span class="px-2 py-0.5 rounded text-xs font-medium bg-yellow-900/50 text-yellow-400">partial</span>
          {% elif t.status == 'failed' %}
            <span class="px-2 py-0.5 rounded text-xs font-medium bg-red-900/50 text-red-400">failed</span>
          {% else %}
            <span class="px-2 py-0.5 rounded text-xs font-medium bg-slate-800 text-slate-400">{{ t.status }}</span>
          {% endif %}
        </td>
      </tr>
      {% if t.error_message %}
      <tr class="border-b border-slate-800/50">
        <td></td>
        <td colspan="10" class="py-1 text-xs text-red-400/80">Error: {{ t.error_message }}</td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
</div>
<!-- Trade Summary -->
<div class="mt-4 bg-slate-900 border border-slate-800 rounded-lg p-4">
  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 text-center mb-4">
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Executed Trades</div>
      <div class="text-sm font-semibold text-slate-300">{{ filled_count }}</div>
    </div>
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Total Invested</div>
      <div class="text-sm font-semibold text-slate-400">${{ "%.2f"|format(total_invested_cents / 100) }}</div>
    </div>
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Realized P&amp;L</div>
      <div class="text-sm font-semibold {{ 'text-emerald-400' if realized_pnl_cents >= 0 else 'text-red-400' }}">
        {{ realized_pnl_cents|signed_dollar }}
      </div>
    </div>
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Total Fees</div>
      <div class="text-sm font-semibold text-amber-400">-${{ "%.2f"|format(total_fees_cents / 100) }}</div>
    </div>
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Net P&amp;L</div>
      <div class="text-sm font-bold {{ 'text-emerald-400' if trade_net_pnl_cents >= 0 else 'text-red-400' }}">
        {{ trade_net_pnl_cents|signed_dollar }}
      </div>
    </div>
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">ROI</div>
      <div class="text-sm font-bold {{ 'text-emerald-400' if trade_roi_pct >= 0 else 'text-red-400' }}">
        {{ "%+.1f"|format(trade_roi_pct) }}%
      </div>
      <div class="text-[10px] text-slate-600 mt-0.5">of ${{ "%.2f"|format(total_invested_cents / 100) }}</div>
    </div>
  </div>
  {% if daily_summary %}
  <div class="border-t border-slate-800/50 pt-3">
    <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-2">Daily Breakdown</div>
    <div class="space-y-1.5">
      {% for d in daily_summary %}
      <div class="flex items-center justify-between text-xs">
        <span class="text-slate-400 font-mono">{{ d.date }}</span>
        <span class="text-slate-300">{{ d.count }} trade{{ 's' if d.count != 1 }} &middot; ${{ "%.2f"|format(d.cost_cents / 100) }} traded &middot; <span class="text-amber-400/70">${{ "%.2f"|format(d.fees_cents / 100) }} fees</span></span>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>
<p class="mt-2 text-sm text-slate-500">{{ trades|length }} trade{{ 's' if trades|length != 1 }} shown</p>
{% else %}
<div class="text-center py-16">
  <div class="text-slate-600 text-lg mb-2">No trades recorded</div>
  <p class="text-slate-500 text-sm">Trade history will appear here after orders are placed.</p>
</div>
{% endif %}

{% if trades %}
<script>
(function() {
  const table = document.getElementById('trades-table');
  if (!table) return;
  const tbody = table.querySelector('tbody');
  const headers = table.querySelectorAll('th[data-sort]');
  let currentSort = null;
  let ascending = true;
  const numericKeys = new Set(['id', 'qty', 'price', 'fee', 'fills']);

  function getValue(row, key) {
    const v = row.dataset[key];
    if (numericKeys.has(key)) return parseFloat(v) || 0;
    return v || '';
  }

  function sortTable(key) {
    if (currentSort === key) {
      ascending = !ascending;
    } else {
      currentSort = key;
      ascending = !numericKeys.has(key);
    }

    // Only sort data rows, keep error rows attached
    const dataRows = Array.from(tbody.querySelectorAll('tr.sort-row'));
    const errorMap = new Map();
    dataRows.forEach(r => {
      const next = r.nextElementSibling;
      if (next && !next.classList.contains('sort-row')) {
        errorMap.set(r, next);
      }
    });

    dataRows.sort((a, b) => {
      let va = getValue(a, key);
      let vb = getValue(b, key);
      let cmp = typeof va === 'string' ? va.localeCompare(vb) : va - vb;
      return ascending ? cmp : -cmp;
    });

    dataRows.forEach(r => {
      tbody.appendChild(r);
      if (errorMap.has(r)) tbody.appendChild(errorMap.get(r));
    });

    headers.forEach(h => {
      const arrow = h.querySelector('.sort-arrow');
      if (h.dataset.sort === key) {
        arrow.textContent = ascending ? ' ▲' : ' ▼';
        h.classList.add('text-slate-300');
      } else {
        arrow.textContent = '';
        h.classList.remove('text-slate-300');
      }
    });
  }

  headers.forEach(h => {
    h.addEventListener('click', () => sortTable(h.dataset.sort));
  });
})();
</script>
{% endif %}
{% endblock %}
