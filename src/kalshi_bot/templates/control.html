{% extends "base.html" %}
{% block title %}Execute - Nightrader{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-white">Execute</h1>
  <form method="post" action="/control/logout">
    <button type="submit" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded text-xs text-slate-400">
      Log Out
    </button>
  </form>
</div>

<!-- Status -->
<div class="bg-slate-900 border border-slate-800 rounded-lg p-5 mb-6">
  <div class="flex items-center gap-3 mb-1">
    <div id="status-dot" class="w-3 h-3 rounded-full {{ 'bg-emerald-400 animate-pulse' if running else 'bg-slate-600' }}"></div>
    <span id="status-text" class="text-sm font-medium {{ 'text-emerald-400' if running else 'text-slate-400' }}">
      {{ 'Running' if running else 'Stopped' }}
    </span>
  </div>
  <p id="status-detail" class="text-xs text-slate-500 mb-4 ml-6">
    {% if running %}Scanning for targets...
    {% else %}Ready to scan and trade
    {% endif %}
  </p>

  <!-- Settings -->
  <form method="post" action="/control/start" id="start-form">
    <div class="flex flex-wrap items-end gap-3 mb-4">
      <div>
        <label class="block text-xs text-slate-500 mb-1">Max Positions</label>
        <input type="number" name="max_positions" value="{{ settings.max_positions }}" min="1" max="50"
          class="bg-slate-800 border border-slate-700 rounded px-3 py-1.5 text-sm text-slate-300 w-20 focus:outline-none focus:border-brand-500">
      </div>
      <label class="flex items-center gap-2 text-sm text-slate-400 pb-1">
        <input type="checkbox" name="dry_run" {{ 'checked' if settings.dry_run }}
          class="rounded bg-slate-800 border-slate-600 text-brand-500 focus:ring-brand-500">
        Dry Run
      </label>
    </div>

    <div class="flex items-center gap-3">
      <button type="submit" id="start-btn" {{ 'disabled' if running }}
        class="px-5 py-2 bg-emerald-600 hover:bg-emerald-700 disabled:opacity-40 disabled:cursor-not-allowed rounded text-sm text-white font-medium">
        Start
      </button>
      <button type="button" id="stop-btn" onclick="document.getElementById('stop-form').submit()" {{ '' if running else 'disabled' }}
        class="px-5 py-2 bg-red-600 hover:bg-red-700 disabled:opacity-40 disabled:cursor-not-allowed rounded text-sm text-white font-medium">
        Stop
      </button>
    </div>
  </form>
  <form method="post" action="/control/stop" id="stop-form" class="hidden"></form>
</div>

<!-- Progress bar -->
<div id="progress-bar" class="hidden bg-slate-900 border border-slate-800 rounded-lg px-4 py-2.5 mb-4 flex items-center gap-5 text-xs">
  <span id="prog-round" class="text-slate-400">Round: —</span>
  <span id="prog-filled" class="text-emerald-400">Filled: 0</span>
  <span id="prog-orders" class="text-slate-400">Orders: 0</span>
  <span id="prog-status" class="text-amber-400"></span>
</div>

<!-- Log viewer -->
<div class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden">
  <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800">
    <span class="text-sm font-medium text-slate-400">Logs</span>
    <button onclick="clearLogs()" class="text-xs text-slate-600 hover:text-slate-400">Clear</button>
  </div>
  <div id="log-box" class="p-4 text-xs font-mono overflow-y-auto max-h-[500px] whitespace-pre-wrap text-slate-400">Waiting for logs...</div>
</div>

<script>
let pollInterval = null;
let lastLogCount = 0;

const TAG_COLORS = {
  'FILL': 'text-emerald-400',
  'WARN': 'text-amber-400',
  'FAIL': 'text-red-400',
  'SKIP': 'text-slate-600',
  'INFO': 'text-slate-400',
  'HEAD': 'text-white',
};

function escapeHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function colorLine(line) {
  const m = line.match(/^\[([A-Z]+)\]/);
  if (m && TAG_COLORS[m[1]]) {
    return '<span class="' + TAG_COLORS[m[1]] + '">' + escapeHtml(line) + '</span>';
  }
  return '<span class="text-slate-400">' + escapeHtml(line) + '</span>';
}

function parseProgress(logs) {
  let round = null, filled = null, total = null, orders = 0, status = '';
  for (let i = logs.length - 1; i >= 0; i--) {
    const line = logs[i];
    // Round N — X/Y filled
    if (round === null) {
      const rm = line.match(/Round (\d+).*?(\d+)\/(\d+) filled/);
      if (rm) { round = rm[1]; filled = rm[2]; total = rm[3]; }
    }
    // Trade N complete. X/Y positions filled.
    if (filled === null) {
      const fm = line.match(/(\d+)\/(\d+) positions filled/);
      if (fm) { filled = fm[1]; total = fm[2]; }
    }
    // Count orders
    if (line.match(/\[FILL\].*(?:FILLED|DRY RUN)/)) orders++;
    if (line.match(/\[SKIP\].*no fill/)) orders++;
    if (line.match(/\[FAIL\].*FAIL/)) orders++;
    // Status hints
    if (!status) {
      if (line.includes('Retrying in')) status = 'Waiting to retry...';
      else if (line.includes('Scanning markets')) status = 'Scanning...';
      else if (line.match(/\[FILL\].*(?:FILLED|DRY RUN)/)) status = 'Filled!';
      else if (line.includes('All') && line.includes('filled')) status = 'Complete';
    }
  }
  return { round, filled, total, orders, status };
}

function pollLogs() {
  fetch('/control/logs')
    .then(r => {
      if (!r.ok || !r.headers.get('content-type').includes('json')) throw new Error('not json');
      return r.json();
    })
    .then(data => {
      const box = document.getElementById('log-box');
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('status-text');
      const startBtn = document.getElementById('start-btn');
      const stopBtn = document.getElementById('stop-btn');
      const detail = document.getElementById('status-detail');
      const progBar = document.getElementById('progress-bar');

      if (data.running) {
        dot.className = 'w-3 h-3 rounded-full bg-emerald-400 animate-pulse';
        text.className = 'text-sm font-medium text-emerald-400';
        text.textContent = 'Running';
        startBtn.disabled = true;
        stopBtn.disabled = false;

        // Progress bar
        const prog = parseProgress(data.logs);
        progBar.classList.remove('hidden');
        document.getElementById('prog-round').textContent = 'Round: ' + (prog.round || '—');
        document.getElementById('prog-filled').textContent = 'Filled: ' + (prog.filled !== null ? prog.filled + '/' + prog.total : '0');
        document.getElementById('prog-orders').textContent = 'Orders: ' + prog.orders;
        document.getElementById('prog-status').textContent = prog.status;

        // Status detail
        let statusMsg = 'Scanning for targets...';
        if (prog.status === 'Waiting to retry...') statusMsg = 'No targets — waiting to retry...';
        else if (prog.filled !== null) statusMsg = prog.filled + '/' + prog.total + ' filled, scanning for next...';
        else if (prog.round) statusMsg = 'Scanning round ' + prog.round + '...';
        detail.textContent = statusMsg;
      } else {
        dot.className = 'w-3 h-3 rounded-full bg-slate-600';
        text.className = 'text-sm font-medium text-slate-400';
        text.textContent = 'Stopped';
        startBtn.disabled = false;
        stopBtn.disabled = true;
        progBar.classList.add('hidden');

        const last = data.logs.length > 0 ? data.logs[data.logs.length - 1] : '';
        if (last.includes('Done') || last.includes('complete') || last.includes('Stopping') || last.includes('filled')) {
          detail.textContent = last.replace(/\[\w+\]\s*/, '');
        } else {
          detail.textContent = 'Ready to scan and trade';
        }
      }

      // Render color-coded logs
      if (data.logs.length > 0) {
        const html = data.logs.map(colorLine).join('\n');
        box.innerHTML = html;
        if (data.logs.length !== lastLogCount) {
          box.scrollTop = box.scrollHeight;
          lastLogCount = data.logs.length;
        }
      } else {
        box.innerHTML = '<span class="text-slate-400">Waiting for logs...</span>';
      }
    })
    .catch(() => {});
}

function clearLogs() {
  document.getElementById('log-box').innerHTML = '<span class="text-slate-400">Waiting for logs...</span>';
  lastLogCount = 0;
}

// Poll every 2 seconds
pollInterval = setInterval(pollLogs, 2000);
// Initial poll
pollLogs();
</script>
{% endblock %}
