{% extends "base.html" %}
{% block title %}Control Panel - Kalshi Bot{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-white">Control Panel</h1>
  <form method="post" action="/control/logout">
    <button type="submit" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded text-xs text-slate-400">
      Log Out
    </button>
  </form>
</div>

<!-- Status -->
<div class="bg-slate-900 border border-slate-800 rounded-lg p-5 mb-6">
  <div class="flex items-center gap-3 mb-4">
    <div id="status-dot" class="w-3 h-3 rounded-full {{ 'bg-emerald-400 animate-pulse' if running else 'bg-slate-600' }}"></div>
    <span id="status-text" class="text-sm font-medium {{ 'text-emerald-400' if running else 'text-slate-400' }}">
      {{ 'Running' if running else 'Stopped' }}
    </span>
  </div>

  <!-- Settings -->
  <form method="post" action="/control/start" id="start-form">
    <div class="flex flex-wrap items-end gap-3 mb-4">
      <div>
        <label class="block text-xs text-slate-500 mb-1">Prefixes</label>
        <input type="text" name="prefixes" value="{{ settings.prefixes }}"
          class="bg-slate-800 border border-slate-700 rounded px-3 py-1.5 text-sm text-slate-300 w-64 focus:outline-none focus:border-brand-500">
      </div>
      <div>
        <label class="block text-xs text-slate-500 mb-1">Max Positions</label>
        <input type="number" name="max_positions" value="{{ settings.max_positions }}" min="1" max="50"
          class="bg-slate-800 border border-slate-700 rounded px-3 py-1.5 text-sm text-slate-300 w-20 focus:outline-none focus:border-brand-500">
      </div>
      <div>
        <label class="block text-xs text-slate-500 mb-1">Max Hours to Exp.</label>
        <input type="number" name="max_hours_to_expiration" value="{{ settings.max_hours }}" placeholder="1" min="1" step="1"
          class="bg-slate-800 border border-slate-700 rounded px-3 py-1.5 text-sm text-slate-300 w-28 focus:outline-none focus:border-brand-500">
      </div>
      <div>
        <label class="block text-xs text-slate-500 mb-1">Cooldown (min)</label>
        <input type="number" name="cooldown_minutes" value="{{ settings.cooldown_minutes }}" min="0.5" step="0.5"
          class="bg-slate-800 border border-slate-700 rounded px-3 py-1.5 text-sm text-slate-300 w-20 focus:outline-none focus:border-brand-500">
      </div>
      <label class="flex items-center gap-2 text-sm text-slate-400 pb-1">
        <input type="checkbox" name="continuous" {{ 'checked' if settings.continuous }}
          class="rounded bg-slate-800 border-slate-600 text-brand-500 focus:ring-brand-500">
        Continuous
      </label>
      <label class="flex items-center gap-2 text-sm text-slate-400 pb-1">
        <input type="checkbox" name="tier1_only" {{ 'checked' if settings.tier1_only }}
          class="rounded bg-slate-800 border-slate-600 text-brand-500 focus:ring-brand-500">
        Tier 1 Only
      </label>
      <label class="flex items-center gap-2 text-sm text-slate-400 pb-1">
        <input type="checkbox" name="dry_run" {{ 'checked' if settings.dry_run }}
          class="rounded bg-slate-800 border-slate-600 text-brand-500 focus:ring-brand-500">
        Dry Run
      </label>
    </div>

    <div class="flex items-center gap-3">
      <button type="submit" id="start-btn" {{ 'disabled' if running }}
        class="px-5 py-2 bg-emerald-600 hover:bg-emerald-700 disabled:opacity-40 disabled:cursor-not-allowed rounded text-sm text-white font-medium">
        Start
      </button>
      <button type="button" id="stop-btn" onclick="document.getElementById('stop-form').submit()" {{ '' if running else 'disabled' }}
        class="px-5 py-2 bg-red-600 hover:bg-red-700 disabled:opacity-40 disabled:cursor-not-allowed rounded text-sm text-white font-medium">
        Stop
      </button>
    </div>
  </form>
  <form method="post" action="/control/stop" id="stop-form" class="hidden"></form>
</div>

<!-- Log viewer -->
<div class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden">
  <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800">
    <span class="text-sm font-medium text-slate-400">Logs</span>
    <button onclick="clearLogs()" class="text-xs text-slate-600 hover:text-slate-400">Clear</button>
  </div>
  <pre id="log-box" class="p-4 text-xs text-slate-400 font-mono overflow-y-auto max-h-[500px] whitespace-pre-wrap">Waiting for logs...</pre>
</div>

<script>
let pollInterval = null;
let lastLogCount = 0;

function pollLogs() {
  fetch('/control/logs')
    .then(r => {
      if (!r.ok || !r.headers.get('content-type').includes('json')) throw new Error('not json');
      return r.json();
    })
    .then(data => {
      const box = document.getElementById('log-box');
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('status-text');
      const startBtn = document.getElementById('start-btn');
      const stopBtn = document.getElementById('stop-btn');

      // Update status
      if (data.running) {
        dot.className = 'w-3 h-3 rounded-full bg-emerald-400 animate-pulse';
        text.className = 'text-sm font-medium text-emerald-400';
        text.textContent = 'Running';
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } else {
        dot.className = 'w-3 h-3 rounded-full bg-slate-600';
        text.className = 'text-sm font-medium text-slate-400';
        text.textContent = 'Stopped';
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }

      // Update logs
      if (data.logs.length > 0) {
        box.textContent = data.logs.join('\n');
        if (data.logs.length !== lastLogCount) {
          box.scrollTop = box.scrollHeight;
          lastLogCount = data.logs.length;
        }
      } else {
        box.textContent = 'Waiting for logs...';
      }
    })
    .catch(() => {});
}

function clearLogs() {
  document.getElementById('log-box').textContent = 'Waiting for logs...';
}

// Poll every 2 seconds
pollInterval = setInterval(pollLogs, 2000);
// Initial poll
pollLogs();
</script>
{% endblock %}
