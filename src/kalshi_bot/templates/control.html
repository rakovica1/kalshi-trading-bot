{% extends "base.html" %}
{% block title %}Execute - Nightrader{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-white">Execute</h1>
  <form method="post" action="/control/logout">
    <button type="submit" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded text-xs text-slate-400">
      Log Out
    </button>
  </form>
</div>

<!-- Status -->
<div class="bg-slate-900 border border-slate-800 rounded-lg p-5 mb-6">
  <div class="flex items-center gap-3 mb-1">
    <div id="status-dot" class="w-3 h-3 rounded-full {{ 'bg-emerald-400 animate-pulse' if running else 'bg-slate-600' }}"></div>
    <span id="status-text" class="text-sm font-medium {{ 'text-emerald-400' if running else 'text-slate-400' }}">
      {{ 'Running' if running else 'Stopped' }}
    </span>
  </div>
  <p id="status-detail" class="text-xs text-slate-500 mb-4 ml-6">
    {% if running %}Scanning for targets...
    {% else %}Ready — select Standard or Riskier order mode
    {% endif %}
  </p>

  <!-- Settings -->
  <form method="post" action="/control/start" id="start-form">
    <div class="flex flex-wrap items-end gap-3 mb-4">
      <div>
        <label class="block text-xs text-slate-500 mb-1">Max Positions</label>
        <input type="number" name="max_positions" value="{{ settings.max_positions }}" min="1" max="50"
          class="bg-slate-800 border border-slate-700 rounded px-3 py-1.5 text-sm text-slate-300 w-20 focus:outline-none focus:border-brand-500">
      </div>
      <label class="flex items-center gap-2 text-sm text-slate-400 pb-1">
        <input type="checkbox" name="dry_run" {{ 'checked' if settings.dry_run }}
          class="rounded bg-slate-800 border-slate-600 text-brand-500 focus:ring-brand-500">
        Dry Run
      </label>
    </div>

    <input type="hidden" name="risk_mode" id="risk-mode-input" value="standard">
    <div class="flex items-center gap-3">
      <button type="submit" id="start-standard-btn" {{ 'disabled' if running }}
        onclick="document.getElementById('risk-mode-input').value='standard'"
        class="px-5 py-2 bg-emerald-600 hover:bg-emerald-700 disabled:opacity-40 disabled:cursor-not-allowed rounded text-sm text-white font-medium">
        Standard Order
      </button>
      <button type="submit" id="start-risky-btn" {{ 'disabled' if running }}
        onclick="document.getElementById('risk-mode-input').value='risky'"
        class="px-5 py-2 bg-amber-600 hover:bg-amber-700 disabled:opacity-40 disabled:cursor-not-allowed rounded text-sm text-white font-medium">
        Riskier Order
      </button>
      <button type="button" id="stop-btn" onclick="document.getElementById('stop-form').submit()" {{ '' if running else 'disabled' }}
        class="px-5 py-2 bg-red-600 hover:bg-red-700 disabled:opacity-40 disabled:cursor-not-allowed rounded text-sm text-white font-medium">
        Stop
      </button>
    </div>
  </form>
  <form method="post" action="/control/stop" id="stop-form" class="hidden"></form>
</div>

<!-- Log viewer -->
<div class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden">
  <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800">
    <span class="text-sm font-medium text-slate-400">Logs</span>
    <button onclick="clearLogs()" class="text-xs text-slate-600 hover:text-slate-400">Clear</button>
  </div>
  <pre id="log-box" class="p-4 text-xs text-slate-400 font-mono overflow-y-auto max-h-[500px] whitespace-pre-wrap">Waiting for logs...</pre>
</div>

<script>
let pollInterval = null;
let lastLogCount = 0;

function pollLogs() {
  fetch('/control/logs')
    .then(r => {
      if (!r.ok || !r.headers.get('content-type').includes('json')) throw new Error('not json');
      return r.json();
    })
    .then(data => {
      const box = document.getElementById('log-box');
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('status-text');
      const startStdBtn = document.getElementById('start-standard-btn');
      const startRiskyBtn = document.getElementById('start-risky-btn');
      const stopBtn = document.getElementById('stop-btn');

      // Update status
      const detail = document.getElementById('status-detail');
      if (data.running) {
        dot.className = 'w-3 h-3 rounded-full bg-emerald-400 animate-pulse';
        text.className = 'text-sm font-medium text-emerald-400';
        text.textContent = 'Running';
        startStdBtn.disabled = true;
        startRiskyBtn.disabled = true;
        stopBtn.disabled = false;
        // Parse last few log lines for rich status
        const logs = data.logs;
        let statusMsg = 'Scanning for targets...';
        for (let i = logs.length - 1; i >= Math.max(0, logs.length - 5); i--) {
          const line = logs[i];
          const fillMatch = line.match(/(\d+)\/(\d+) (?:positions? )?filled/);
          const roundMatch = line.match(/Round (\d+)/);
          const modeMatch = line.match(/\[(STANDARD|RISKIER)\]/);
          const retryMatch = line.match(/Retrying in (\d+)s/);
          if (retryMatch) {
            statusMsg = 'No targets — waiting to retry...';
            break;
          } else if (fillMatch) {
            statusMsg = 'Position ' + fillMatch[1] + '/' + fillMatch[2] + ' filled, scanning for next...';
            break;
          } else if (roundMatch) {
            const mode = modeMatch ? modeMatch[1].toLowerCase() : '';
            statusMsg = 'Scanning round ' + roundMatch[1] + (mode ? ' (' + mode + ')' : '') + '...';
            break;
          }
        }
        detail.textContent = statusMsg;
      } else {
        dot.className = 'w-3 h-3 rounded-full bg-slate-600';
        text.className = 'text-sm font-medium text-slate-400';
        text.textContent = 'Stopped';
        startStdBtn.disabled = false;
        startRiskyBtn.disabled = false;
        stopBtn.disabled = true;
        // Show completion message if logs indicate it
        const last = data.logs.length > 0 ? data.logs[data.logs.length - 1] : '';
        if (last.includes('Done') || last.includes('complete') || last.includes('Stopping')) {
          detail.textContent = last.replace(/\[(STANDARD|RISKIER)\]\s*/, '');
        } else {
          const maxPos = document.querySelector('input[name="max_positions"]');
          detail.textContent = 'Ready — select Standard or Riskier order mode';
        }
      }

      // Update logs
      if (data.logs.length > 0) {
        box.textContent = data.logs.join('\n');
        if (data.logs.length !== lastLogCount) {
          box.scrollTop = box.scrollHeight;
          lastLogCount = data.logs.length;
        }
      } else {
        box.textContent = 'Waiting for logs...';
      }
    })
    .catch(() => {});
}

function clearLogs() {
  document.getElementById('log-box').textContent = 'Waiting for logs...';
}

// Poll every 2 seconds
pollInterval = setInterval(pollLogs, 2000);
// Initial poll
pollLogs();
</script>
{% endblock %}
