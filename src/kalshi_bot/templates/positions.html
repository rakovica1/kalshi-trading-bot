{% extends "base.html" %}
{% block title %}Positions - Nightrader{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold text-white mb-6">Open Positions</h1>

{% if portfolio_snapshots and portfolio_snapshots|length > 1 %}
<!-- Aggregated Portfolio Chart -->
<div class="bg-slate-900 border border-slate-800 rounded-lg p-5 mb-6">
  <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wide mb-4">Portfolio Unrealized P&amp;L</h2>
  <div style="height: 400px;">
    <canvas id="portfolio-chart"></canvas>
  </div>
</div>
{% endif %}

{% if positions %}
<div class="overflow-x-auto">
  <table class="w-full text-sm" id="positions-table">
    <thead>
      <tr class="border-b border-slate-800 text-left text-xs text-slate-500 uppercase tracking-wide">
        <th class="pb-3 pr-4 cursor-pointer hover:text-slate-300 select-none" data-sort="ticker">Ticker <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-4 cursor-pointer hover:text-slate-300 select-none" data-sort="opened">Opened <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-4 cursor-pointer hover:text-slate-300 select-none" data-sort="side">Side <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-4 text-right cursor-pointer hover:text-slate-300 select-none" data-sort="qty">Qty <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-4 text-right cursor-pointer hover:text-slate-300 select-none" data-sort="entry">Entry <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-4 text-right cursor-pointer hover:text-slate-300 select-none" data-sort="cost">Cost <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-4 text-right cursor-pointer hover:text-slate-300 select-none" data-sort="current">Current <span class="sort-arrow"></span></th>
        <th class="pb-3 pr-4 text-right cursor-pointer hover:text-slate-300 select-none" data-sort="status">Status <span class="sort-arrow"></span></th>
        <th class="pb-3 text-right cursor-pointer hover:text-slate-300 select-none" data-sort="pnl">Unrealized P&amp;L <span class="sort-arrow"></span></th>
      </tr>
    </thead>
    <tbody>
      {% for p in positions %}
      <tr class="border-b border-slate-800/50 hover:bg-slate-900/50"
          data-ticker="{{ p.ticker|decode_ticker }}"
          data-opened="{{ p.opened_at }}"
          data-side="{{ p.side }}"
          data-qty="{{ p.quantity }}"
          data-entry="{{ p.avg_entry_price_cents }}"
          data-cost="{{ p.total_cost_cents }}"
          data-current="{{ p.current_price }}"
          data-status="{{ p.close_time }}"
          data-pnl="{{ p.unrealized_bid_cents }}">
        <td class="py-3 pr-4">
          <div class="text-sm text-slate-200">{{ p.ticker|decode_ticker }}</div>
          <div class="text-[10px] font-mono text-slate-500 mt-0.5">{{ p.ticker }}</div>
        </td>
        <td class="py-3 pr-4">
          <div class="text-xs text-slate-400">{{ p.opened_at_display }}</div>
          <div class="text-[10px] text-slate-500 mt-0.5 time-ago" data-utc="{{ p.opened_at }}"></div>
        </td>
        <td class="py-3 pr-4">
          <span class="px-2 py-0.5 rounded text-xs font-medium {{ 'bg-emerald-900/50 text-emerald-400' if p.side == 'yes' else 'bg-red-900/50 text-red-400' }}">
            {{ p.side|upper }}
          </span>
        </td>
        <td class="py-3 pr-4 text-right text-slate-300">{{ p.quantity }}</td>
        <td class="py-3 pr-4 text-right text-slate-400">{{ "%.0f"|format(p.avg_entry_price_cents) }}c</td>
        <td class="py-3 pr-4 text-right text-slate-400">${{ "%.2f"|format(p.total_cost_cents / 100) }}</td>
        <td class="py-3 pr-4 text-right text-slate-300">{{ p.current_price }}c</td>
        <td class="py-3 pr-4 text-right expires-cell" data-close-time="{{ p.close_time }}" data-settled="{{ 'true' if p.is_settled else 'false' }}">
          {% if p.is_settled %}
            <span class="px-2 py-0.5 rounded text-xs font-bold bg-blue-900/50 text-blue-400">SETTLED</span>
          {% else %}
            <div class="text-xs expires-time"></div>
            <div class="text-[10px] mt-0.5 expires-relative"></div>
          {% endif %}
        </td>
        <td class="py-3 text-right">
          <div class="flex items-center justify-end gap-2">
            <div>
              <div class="text-[9px] text-slate-600">Bid</div>
              <div class="text-xs font-medium {{ 'text-emerald-400' if p.unrealized_bid_cents >= 0 else 'text-red-400' }}">
                ${{ "%+.2f"|format(p.unrealized_bid_cents / 100) }}
              </div>
            </div>
            <div class="text-slate-700 text-xs">/</div>
            <div>
              <div class="text-[9px] text-slate-600">Ask</div>
              <div class="text-xs font-medium {{ 'text-emerald-400' if p.unrealized_ask_cents >= 0 else 'text-red-400' }}">
                ${{ "%+.2f"|format(p.unrealized_ask_cents / 100) }}
              </div>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<!-- Position Summary -->
<div class="mt-4 bg-slate-900 border border-slate-800 rounded-lg p-4">
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Positions</div>
      <div class="text-sm font-semibold text-slate-300">{{ positions|length }}</div>
    </div>
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Cost Basis</div>
      <div class="text-sm font-semibold text-slate-400">${{ "%.2f"|format(total_cost_cents / 100) }}</div>
    </div>
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Current Value</div>
      <div class="text-sm font-semibold text-slate-300">${{ "%.2f"|format(total_value_cents / 100) }}</div>
    </div>
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Unrealized P&amp;L</div>
      <div class="flex items-center justify-center gap-2">
        <div>
          <div class="text-[9px] text-slate-600">Bid</div>
          <div class="text-sm font-bold {{ 'text-emerald-400' if total_unrealized_bid_cents >= 0 else 'text-red-400' }}">
            ${{ "%+.2f"|format(total_unrealized_bid_cents / 100) }}
          </div>
        </div>
        <div class="text-slate-700">/</div>
        <div>
          <div class="text-[9px] text-slate-600">Ask</div>
          <div class="text-sm font-bold {{ 'text-emerald-400' if total_unrealized_ask_cents >= 0 else 'text-red-400' }}">
            ${{ "%+.2f"|format(total_unrealized_ask_cents / 100) }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% else %}
<div class="text-center py-16">
  <div class="text-slate-600 text-lg mb-2">No open positions</div>
  <p class="text-slate-500 text-sm">Positions will appear here when you place trades.</p>
</div>
{% endif %}

{% if closed_positions %}
<!-- Closed Positions (collapsible) -->
<div class="mt-8">
  <button id="toggle-closed" onclick="document.getElementById('closed-section').classList.toggle('hidden'); this.querySelector('.toggle-arrow').classList.toggle('rotate-90');"
    class="flex items-center gap-2 text-sm text-slate-400 hover:text-slate-300 transition-colors mb-4">
    <span class="toggle-arrow text-xs transition-transform">&rsaquo;</span>
    Show Closed Positions ({{ closed_positions|length }})
  </button>
  <div id="closed-section" class="hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-slate-800 text-left text-xs text-slate-500 uppercase tracking-wide">
            <th class="pb-3 pr-4">Ticker</th>
            <th class="pb-3 pr-4">Opened</th>
            <th class="pb-3 pr-4">Closed</th>
            <th class="pb-3 pr-4">Side</th>
            <th class="pb-3 pr-4 text-right">Entry</th>
            <th class="pb-3 pr-4 text-right">Status</th>
            <th class="pb-3 text-right">Realized P&amp;L</th>
          </tr>
        </thead>
        <tbody>
          {% for p in closed_positions %}
          <tr class="border-b border-slate-800/50 hover:bg-slate-900/30 opacity-70">
            <td class="py-3 pr-4">
              <div class="text-sm text-slate-300">{{ p.ticker|decode_ticker }}</div>
              <div class="text-[10px] font-mono text-slate-600 mt-0.5">{{ p.ticker }}</div>
            </td>
            <td class="py-3 pr-4">
              <div class="text-xs text-slate-500">{{ p.opened_at_display }}</div>
            </td>
            <td class="py-3 pr-4">
              <div class="text-xs text-slate-500">{{ p.closed_at_display }}</div>
            </td>
            <td class="py-3 pr-4">
              <span class="px-2 py-0.5 rounded text-xs font-medium {{ 'bg-emerald-900/30 text-emerald-500/70' if p.side == 'yes' else 'bg-red-900/30 text-red-500/70' }}">
                {{ p.side|upper }}
              </span>
            </td>
            <td class="py-3 pr-4 text-right text-slate-500">{{ "%.0f"|format(p.avg_entry_price_cents) }}c</td>
            <td class="py-3 pr-4 text-right">
              <span class="px-2 py-0.5 rounded text-xs font-bold bg-slate-800 text-slate-400">SETTLED</span>
            </td>
            <td class="py-3 text-right font-medium {{ 'text-emerald-400/70' if p.realized_pnl_cents >= 0 else 'text-red-400/70' }}">
              ${{ "%+.2f"|format(p.realized_pnl_cents / 100) }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<script>
// Format "time ago" for opened_at
function formatTimeAgo(utcStr) {
  if (!utcStr) return '';
  let d;
  if (utcStr.includes('T')) {
    d = new Date(utcStr);
  } else {
    d = new Date(utcStr.replace(' ', 'T') + 'Z');
  }
  if (isNaN(d)) return '';
  const ms = Date.now() - d.getTime();
  if (ms < 0) return 'just now';
  const mins = Math.floor(ms / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hours = Math.floor(mins / 60);
  if (hours < 24) return hours + 'h ' + (mins % 60) + 'm ago';
  const days = Math.floor(hours / 24);
  return days + 'd ' + (hours % 24) + 'h ago';
}

// Format expiration time
function formatExpires(closeTime) {
  if (!closeTime) return { time: '—', relative: '', urgency: 'none' };
  const close = new Date(closeTime);
  if (isNaN(close)) return { time: '—', relative: '', urgency: 'none' };

  const now = new Date();
  const ms = close - now;

  // Format the absolute time in EST
  const estOpts = { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZone: 'America/New_York' };
  const timeStr = close.toLocaleString('en-US', estOpts);

  if (ms <= 0) return { time: timeStr, relative: 'Expired', urgency: 'expired' };

  const hours = ms / 3600000;
  let relStr;
  if (hours < 1) {
    relStr = 'in ' + Math.round(hours * 60) + 'm';
  } else if (hours < 48) {
    const h = Math.floor(hours);
    const m = Math.round((hours - h) * 60);
    relStr = 'in ' + h + 'h ' + m + 'm';
  } else {
    relStr = 'in ' + (hours / 24).toFixed(1) + 'd';
  }

  let urgency = 'normal';
  if (hours < 1) urgency = 'critical';
  else if (hours < 6) urgency = 'warning';

  return { time: timeStr, relative: relStr, urgency: urgency };
}

function updateAll() {
  // Time ago
  document.querySelectorAll('.time-ago').forEach(el => {
    el.textContent = formatTimeAgo(el.dataset.utc);
  });

  // Expires (skip settled cells)
  document.querySelectorAll('.expires-cell').forEach(cell => {
    if (cell.dataset.settled === 'true') return;
    const info = formatExpires(cell.dataset.closeTime);
    const timeEl = cell.querySelector('.expires-time');
    const relEl = cell.querySelector('.expires-relative');
    if (!timeEl || !relEl) return;

    timeEl.textContent = info.time;
    relEl.textContent = info.relative;

    // Color coding
    timeEl.className = 'text-xs expires-time';
    relEl.className = 'text-[10px] mt-0.5 expires-relative';
    if (info.urgency === 'critical') {
      timeEl.classList.add('text-red-400');
      relEl.classList.add('text-red-400', 'font-medium');
    } else if (info.urgency === 'warning') {
      timeEl.classList.add('text-amber-400');
      relEl.classList.add('text-amber-400');
    } else if (info.urgency === 'expired') {
      timeEl.classList.add('text-slate-500');
      relEl.classList.add('text-red-400', 'font-medium');
    } else {
      timeEl.classList.add('text-slate-300');
      relEl.classList.add('text-slate-500');
    }
  });
}

updateAll();
setInterval(updateAll, 30000);

// Table sorting
(function() {
  const table = document.getElementById('positions-table');
  if (!table) return;
  const tbody = table.querySelector('tbody');
  const headers = table.querySelectorAll('th[data-sort]');
  let currentSort = null;
  let ascending = true;

  function getValue(row, key) {
    const v = row.dataset[key];
    if (key === 'ticker' || key === 'side') return v || '';
    if (key === 'opened' || key === 'status') return v || '';
    return parseFloat(v) || 0;
  }

  function sortTable(key) {
    if (currentSort === key) {
      ascending = !ascending;
    } else {
      currentSort = key;
      ascending = (key === 'ticker' || key === 'side' || key === 'opened');
    }

    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a, b) => {
      let va = getValue(a, key);
      let vb = getValue(b, key);
      let cmp;
      if (typeof va === 'string') {
        cmp = va.localeCompare(vb);
      } else {
        cmp = va - vb;
      }
      return ascending ? cmp : -cmp;
    });

    rows.forEach(r => tbody.appendChild(r));

    // Update arrows
    headers.forEach(h => {
      const arrow = h.querySelector('.sort-arrow');
      if (h.dataset.sort === key) {
        arrow.textContent = ascending ? ' ▲' : ' ▼';
        h.classList.add('text-slate-300');
      } else {
        arrow.textContent = '';
        h.classList.remove('text-slate-300');
      }
    });
  }

  headers.forEach(h => {
    h.addEventListener('click', () => sortTable(h.dataset.sort));
  });
})();
</script>

{% if portfolio_snapshots and portfolio_snapshots|length > 1 %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
const snapData = {{ portfolio_snapshots|tojson }};
const labels = snapData.map(d => {
  const dt = new Date(d.ts);
  return dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', timeZone: 'America/New_York' });
});
const bidValues = snapData.map(d => d.unrealized_bid / 100);
const askValues = snapData.map(d => d.unrealized_ask / 100);

const ctx = document.getElementById('portfolio-chart');
new Chart(ctx, {
  type: 'line',
  data: {
    labels: labels,
    datasets: [
      {
        label: 'Bid P&L',
        data: bidValues,
        borderColor: 'rgba(16, 185, 129, 0.8)',
        backgroundColor: 'rgba(16, 185, 129, 0.05)',
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 4,
        pointBackgroundColor: '#10b981',
        tension: 0.3,
        fill: true,
      },
      {
        label: 'Ask P&L',
        data: askValues,
        borderColor: 'rgba(96, 165, 250, 0.8)',
        backgroundColor: 'rgba(96, 165, 250, 0.05)',
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 4,
        pointBackgroundColor: '#60a5fa',
        tension: 0.3,
        fill: true,
      },
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    scales: {
      x: {
        grid: { color: 'rgba(51, 65, 85, 0.25)' },
        ticks: { color: '#64748b', font: { size: 9 }, maxTicksLimit: 12, maxRotation: 0 },
        border: { color: 'rgba(51, 65, 85, 0.4)' },
      },
      y: {
        grid: { color: 'rgba(51, 65, 85, 0.25)' },
        ticks: {
          color: '#64748b',
          font: { size: 10 },
          callback: v => '$' + (v >= 0 ? '+' : '') + v.toFixed(2),
        },
        border: { color: 'rgba(51, 65, 85, 0.4)' },
      },
    },
    plugins: {
      legend: {
        display: true, position: 'top', align: 'end',
        labels: { color: '#94a3b8', font: { size: 10 }, boxWidth: 14, padding: 12 },
      },
      tooltip: {
        backgroundColor: '#0f172a',
        titleColor: '#e2e8f0',
        bodyColor: '#cbd5e1',
        borderColor: '#334155',
        borderWidth: 1,
        padding: 12,
        callbacks: {
          label: function(ctx) {
            const v = ctx.parsed.y;
            return ctx.dataset.label + ': $' + (v >= 0 ? '+' : '') + v.toFixed(2);
          },
        },
      },
    },
  },
});
</script>
{% endif %}
{% endblock %}
