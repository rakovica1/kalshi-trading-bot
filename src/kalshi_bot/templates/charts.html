{% extends "base.html" %}
{% block title %}Charts - Nightrader{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-white">Position Charts</h1>
  <div class="flex items-center gap-3">
    <span id="update-status" class="text-xs text-slate-500"></span>
    <div class="flex items-center gap-2 text-xs text-slate-500">
      <span class="inline-block w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
      Live &mdash; 60s refresh
    </div>
  </div>
</div>

{% if positions %}
<!-- Portfolio Summary -->
<div class="bg-slate-900 border border-slate-800 rounded-lg p-4 mb-6">
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Open Positions</div>
      <div class="text-sm font-semibold text-slate-300">{{ positions|length }}</div>
    </div>
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Total Invested</div>
      <div class="text-sm font-semibold text-slate-400">${{ "%.2f"|format(portfolio_cost_cents / 100) }}</div>
    </div>
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Portfolio Value</div>
      <div class="text-sm font-semibold text-slate-300">${{ "%.2f"|format(portfolio_value_cents / 100) }}</div>
    </div>
    <div>
      <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Unrealized P&amp;L</div>
      <div class="text-sm font-bold {{ 'text-emerald-400' if portfolio_unrealized_cents >= 0 else 'text-red-400' }}">
        {{ portfolio_unrealized_cents|signed_dollar }}
      </div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-2 gap-6" id="charts-grid">
  {% for p in positions %}
  {% set pnl_per = p.current_bid - p.avg_entry_price_cents %}
  {% set is_winning = pnl_per >= 0 %}
  <div class="bg-slate-900 border {{ 'border-emerald-900/40' if is_winning else 'border-red-900/40' }} rounded-lg overflow-hidden"
       data-ticker="{{ p.ticker }}" data-side="{{ p.side }}" data-index="{{ loop.index0 }}">
    <!-- Header -->
    <div class="px-5 pt-4 pb-3 border-b border-slate-800/50">
      <div class="flex items-center justify-between">
        <div class="min-w-0 flex-1">
          <h2 class="text-sm font-semibold text-slate-200 truncate">{{ p.ticker|decode_ticker }}</h2>
          <div class="text-[10px] font-mono text-slate-500 truncate">{{ p.ticker }}</div>
          <div class="flex items-center gap-2 mt-1.5">
            <span class="px-2 py-0.5 rounded text-[10px] font-bold {{ 'bg-emerald-900/50 text-emerald-400' if p.side == 'yes' else 'bg-red-900/50 text-red-400' }}">
              {{ p.side|upper }}
            </span>
            <span class="text-xs text-slate-500">{{ p.quantity }} contract{{ 's' if p.quantity != 1 }}</span>
          </div>
        </div>
        <div class="text-right ml-4">
          <!-- Big P&L with direction arrow -->
          <div class="flex items-center justify-end gap-1.5">
            <span class="text-lg direction-arrow {{ 'text-emerald-400' if is_winning else 'text-red-400' }}">{{ '▲' if is_winning else '▼' }}</span>
            <span class="text-xl font-bold pnl-display {{ 'text-emerald-400' if is_winning else 'text-red-400' }}">
              {{ p.unrealized_cents|signed_dollar }}
            </span>
          </div>
          <!-- % change -->
          {% if p.avg_entry_price_cents > 0 %}
          {% set pct_change = (pnl_per / p.avg_entry_price_cents * 100) %}
          <div class="text-xs font-medium pct-display {{ 'text-emerald-400/70' if is_winning else 'text-red-400/70' }}">
            {{ "%+.1f"|format(pct_change) }}%
          </div>
          {% endif %}
          <div class="text-[10px] text-slate-500 uppercase tracking-wide">Unrealized P&amp;L</div>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="px-3 py-2" style="height: 280px;">
      <canvas id="chart-{{ loop.index0 }}"></canvas>
    </div>

    <!-- Stats bar -->
    <div class="grid grid-cols-5 border-t border-slate-800/50 text-center">
      <div class="px-2 py-3 border-r border-slate-800/30">
        <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Entry</div>
        <div class="text-sm font-semibold text-amber-400 entry-display">{{ "%.0f"|format(p.avg_entry_price_cents) }}&cent;</div>
      </div>
      <div class="px-2 py-3 border-r border-slate-800/30">
        <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Bid / Ask</div>
        <div class="text-sm font-semibold bid-ask-display">
          <span class="{{ 'text-emerald-400' if is_winning else 'text-red-400' }}">{{ p.current_bid }}&cent;</span>
          <span class="text-slate-600">/</span>
          <span class="text-slate-400">{{ p.current_ask }}&cent;</span>
        </div>
      </div>
      <div class="px-2 py-3 border-r border-slate-800/30">
        <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Change</div>
        <div class="text-sm font-bold per-contract-display {{ 'text-emerald-400' if is_winning else 'text-red-400' }}">
          {{ "%+.0f"|format(pnl_per) }}&cent;
        </div>
      </div>
      <div class="px-2 py-3 border-r border-slate-800/30">
        <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">High / Low</div>
        <div class="text-sm font-semibold high-low-display">
          <span class="text-emerald-400/70">{{ p.bid_high }}&cent;</span>
          <span class="text-slate-600">/</span>
          <span class="text-red-400/70">{{ p.bid_low }}&cent;</span>
        </div>
      </div>
      <div class="px-2 py-3">
        <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Time Left</div>
        <div class="text-sm font-semibold text-slate-300 time-left-display" data-close-time="{{ p.close_time }}">
          &mdash;
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<p class="mt-4 text-sm text-slate-500">{{ positions|length }} open position{{ 's' if positions|length != 1 }}</p>

{% else %}
{% if not closed_positions %}
<div class="text-center py-16">
  <div class="text-slate-600 text-lg mb-2">No open positions to chart</div>
  <p class="text-slate-500 text-sm">Charts will appear here when you have open positions.</p>
  <a href="/positions" class="inline-block mt-4 px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-md text-sm text-slate-300">View Positions &rarr;</a>
</div>
{% endif %}
{% endif %}

{% if closed_positions %}
<!-- Closed Positions (collapsible) -->
<div class="mt-8">
  <button id="toggle-closed-charts" onclick="document.getElementById('closed-charts-section').classList.toggle('hidden'); this.querySelector('.toggle-arrow').classList.toggle('rotate-90');"
    class="flex items-center gap-2 text-sm text-slate-400 hover:text-slate-300 transition-colors mb-4">
    <span class="toggle-arrow text-xs transition-transform">&rsaquo;</span>
    Show Closed Positions ({{ closed_positions|length }})
  </button>
  <div id="closed-charts-section" class="hidden">
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
      {% for p in closed_positions %}
      {% set pnl_per = p.unrealized_cents %}
      {% set is_winning = pnl_per >= 0 %}
      <div class="bg-slate-900/60 border border-slate-800/60 rounded-lg overflow-hidden opacity-75">
        <!-- Header -->
        <div class="px-5 pt-4 pb-3 border-b border-slate-800/50">
          <div class="flex items-center justify-between">
            <div class="min-w-0 flex-1">
              <div class="flex items-center gap-2">
                <h2 class="text-sm font-semibold text-slate-300 truncate">{{ p.ticker|decode_ticker }}</h2>
                <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-800 text-slate-400 shrink-0">SETTLED</span>
              </div>
              <div class="text-[10px] font-mono text-slate-600 truncate">{{ p.ticker }}</div>
              <div class="flex items-center gap-2 mt-1.5">
                <span class="px-2 py-0.5 rounded text-[10px] font-bold {{ 'bg-emerald-900/30 text-emerald-500/70' if p.side == 'yes' else 'bg-red-900/30 text-red-500/70' }}">
                  {{ p.side|upper }}
                </span>
                <span class="text-xs text-slate-600">{{ p.quantity }} contract{{ 's' if p.quantity != 1 }}</span>
              </div>
            </div>
            <div class="text-right ml-4">
              <div class="flex items-center justify-end gap-1.5">
                <span class="text-lg {{ 'text-emerald-400/70' if is_winning else 'text-red-400/70' }}">{{ '▲' if is_winning else '▼' }}</span>
                <span class="text-xl font-bold {{ 'text-emerald-400/70' if is_winning else 'text-red-400/70' }}">
                  {{ pnl_per|signed_dollar }}
                </span>
              </div>
              <div class="text-[10px] text-slate-600 uppercase tracking-wide">Realized P&amp;L</div>
            </div>
          </div>
        </div>

        <!-- Stats bar (simplified for settled) -->
        <div class="grid grid-cols-3 border-t border-slate-800/50 text-center">
          <div class="px-2 py-3 border-r border-slate-800/30">
            <div class="text-[10px] text-slate-600 uppercase tracking-wide mb-0.5">Entry</div>
            <div class="text-sm font-semibold text-amber-400/70">{{ "%.0f"|format(p.avg_entry_price_cents) }}&cent;</div>
          </div>
          <div class="px-2 py-3 border-r border-slate-800/30">
            <div class="text-[10px] text-slate-600 uppercase tracking-wide mb-0.5">Settlement</div>
            <div class="text-sm font-semibold {{ 'text-emerald-400/70' if is_winning else 'text-red-400/70' }}">{{ p.current_bid }}&cent;</div>
          </div>
          <div class="px-2 py-3">
            <div class="text-[10px] text-slate-600 uppercase tracking-wide mb-0.5">Status</div>
            <div class="text-sm font-semibold text-slate-400">Settled</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
// ---------- Time left helper ----------
function formatTimeLeft(closeTime) {
  if (!closeTime) return '—';
  const close = new Date(closeTime);
  const now = new Date();
  const ms = close - now;
  if (ms <= 0) return 'Settled';
  const hours = ms / 3600000;
  if (hours < 1) return Math.round(hours * 60) + 'm';
  if (hours < 48) {
    const h = Math.floor(hours);
    const m = Math.round((hours % 1) * 60);
    return h + 'h ' + m + 'm';
  }
  return (hours / 24).toFixed(1) + 'd';
}

function updateTimers() {
  document.querySelectorAll('.time-left-display').forEach(el => {
    const tl = formatTimeLeft(el.dataset.closeTime);
    el.textContent = tl;
    // Color code time left
    if (!el.dataset.closeTime) return;
    const ms = new Date(el.dataset.closeTime) - new Date();
    const hours = ms / 3600000;
    el.className = 'text-sm font-semibold time-left-display';
    if (hours <= 0) el.classList.add('text-blue-400');
    else if (hours < 1) el.classList.add('text-red-400');
    else if (hours < 6) el.classList.add('text-amber-400');
    else el.classList.add('text-slate-300');
  });
}
updateTimers();
setInterval(updateTimers, 30000);

// ---------- Chart instances ----------
const charts = {};

// Initial data from server
const positionData = [
  {% for p in positions %}
  {
    ticker: {{ p.ticker|tojson }},
    side: {{ p.side|tojson }},
    entry: {{ p.avg_entry_price_cents }},
    qty: {{ p.quantity }},
    bid: {{ p.current_bid }},
    ask: {{ p.current_ask }},
    closeTime: {{ p.close_time|tojson }},
    history: {{ p.history|tojson }},
    bidHigh: {{ p.bid_high }},
    bidLow: {{ p.bid_low }}
  }{{ "," if not loop.last }}
  {% endfor %}
];

// ---------- Helper: parse history point timestamp ----------
function historyTime(h) {
  if (h.ts) return new Date(h.ts * 1000);
  if (h.recorded_at) return new Date(h.recorded_at);
  return new Date();
}

// ---------- Create charts ----------
function createChart(index, data) {
  const ctx = document.getElementById('chart-' + index);
  if (!ctx) return;

  const entry = data.entry;
  const isWinning = data.bid >= entry;
  const lineColor = isWinning ? '#10b981' : '#ef4444';
  const fillColor = isWinning ? 'rgba(16, 185, 129, 0.12)' : 'rgba(239, 68, 68, 0.12)';

  const historyPoints = data.history.map(h => ({
    x: historyTime(h), y: h.bid_cents
  }));
  if (data.bid > 0) {
    historyPoints.push({ x: new Date(), y: data.bid });
  }
  if (historyPoints.length === 0 && data.bid > 0) {
    historyPoints.push({ x: new Date(), y: data.bid });
  }

  const askPoints = data.history.map(h => ({
    x: historyTime(h), y: h.ask_cents
  }));
  if (data.ask > 0) {
    askPoints.push({ x: new Date(), y: data.ask });
  }

  // Entry line as a flat dataset spanning the full time range
  const entryLineData = [];
  if (historyPoints.length > 0) {
    entryLineData.push({ x: historyPoints[0].x, y: entry });
    entryLineData.push({ x: historyPoints[historyPoints.length - 1].x, y: entry });
  }

  // Determine Y-axis range
  const allPrices = historyPoints.map(p => p.y).concat(askPoints.map(p => p.y)).concat([entry]);
  const minPrice = Math.max(0, Math.min(...allPrices) - 3);
  const maxPrice = Math.min(100, Math.max(...allPrices) + 3);

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [
        {
          label: 'Bid',
          data: historyPoints,
          borderColor: lineColor,
          backgroundColor: fillColor,
          borderWidth: 2.5,
          pointRadius: function(ctx) {
            // Show point for last data point only
            return ctx.dataIndex === ctx.dataset.data.length - 1 ? 5 : 0;
          },
          pointBackgroundColor: lineColor,
          pointBorderColor: isWinning ? 'rgba(16, 185, 129, 0.4)' : 'rgba(239, 68, 68, 0.4)',
          pointBorderWidth: 3,
          pointHoverRadius: 5,
          tension: 0.3,
          fill: {
            target: { value: entry },
            above: 'rgba(16, 185, 129, 0.10)',
            below: 'rgba(239, 68, 68, 0.10)',
          },
          order: 1,
        },
        {
          label: 'Ask',
          data: askPoints,
          borderColor: 'rgba(96, 165, 250, 0.6)',
          backgroundColor: 'transparent',
          borderWidth: 1.5,
          borderDash: [4, 3],
          pointRadius: function(ctx) {
            return ctx.dataIndex === ctx.dataset.data.length - 1 ? 3 : 0;
          },
          pointBackgroundColor: 'rgba(96, 165, 250, 0.8)',
          pointBorderColor: 'rgba(96, 165, 250, 0.3)',
          pointBorderWidth: 2,
          pointHoverRadius: 4,
          tension: 0.3,
          fill: false,
          order: 2,
        },
        {
          label: 'Entry: ' + entry + '¢',
          data: entryLineData,
          borderColor: '#fbbf24',
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [8, 4],
          pointRadius: 0,
          pointHoverRadius: 0,
          tension: 0,
          fill: false,
          order: 3,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 500, easing: 'easeInOutQuart' },
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          type: 'time',
          time: {
            tooltipFormat: 'MMM d, h:mm a',
            displayFormats: {
              second: 'h:mm a',
              minute: 'h:mm a',
              hour: 'ha',
              day: 'MMM d'
            }
          },
          grid: { color: 'rgba(51, 65, 85, 0.25)' },
          ticks: {
            color: '#64748b',
            font: { size: 9 },
            maxTicksLimit: 6,
            autoSkip: true,
            autoSkipPadding: 20,
            maxRotation: 0,
          },
          border: { color: 'rgba(51, 65, 85, 0.4)' }
        },
        y: {
          min: minPrice,
          max: maxPrice,
          grid: { color: 'rgba(51, 65, 85, 0.25)' },
          ticks: {
            color: '#64748b',
            font: { size: 10 },
            callback: v => v + '¢',
            stepSize: 1
          },
          border: { color: 'rgba(51, 65, 85, 0.4)' }
        }
      },
      plugins: {
        legend: {
          display: true, position: 'top', align: 'end',
          labels: {
            color: '#94a3b8', font: { size: 10 }, boxWidth: 14, padding: 12,
            usePointStyle: false,
          }
        },
        tooltip: {
          backgroundColor: '#0f172a',
          titleColor: '#e2e8f0',
          bodyColor: '#cbd5e1',
          borderColor: '#334155',
          borderWidth: 1,
          padding: 12,
          displayColors: true,
          callbacks: {
            label: function(ctx) {
              const val = ctx.parsed.y;
              const diff = val - entry;
              const prefix = diff >= 0 ? '+' : '';
              if (ctx.datasetIndex === 2) return 'Entry: ' + entry + '¢';
              return ctx.dataset.label + ': ' + val + '¢ (' + prefix + diff + '¢)';
            }
          }
        }
      }
    },
    plugins: [
    {
      // Background profit/loss zone shading
      id: 'profitZone',
      beforeDatasetsDraw(chart) {
        const yScale = chart.scales.y;
        const entryY = yScale.getPixelForValue(entry);
        const c = chart.ctx;
        const area = chart.chartArea;
        if (entryY > area.top && entryY < area.bottom) {
          c.save();
          c.fillStyle = 'rgba(16, 185, 129, 0.03)';
          c.fillRect(area.left, area.top, area.right - area.left, entryY - area.top);
          c.fillStyle = 'rgba(239, 68, 68, 0.03)';
          c.fillRect(area.left, entryY, area.right - area.left, area.bottom - entryY);
          c.restore();
        }
      }
    },
    {
      // Entry price line + label
      id: 'entryLine',
      afterDatasetsDraw(chart) {
        const yScale = chart.scales.y;
        const yPos = yScale.getPixelForValue(entry);
        if (yPos < yScale.top || yPos > yScale.bottom) return;
        const c = chart.ctx;
        const area = chart.chartArea;
        c.save();
        // Line
        c.strokeStyle = '#fbbf24';
        c.lineWidth = 2;
        c.setLineDash([8, 4]);
        c.beginPath();
        c.moveTo(area.left, yPos);
        c.lineTo(area.right, yPos);
        c.stroke();
        c.setLineDash([]);
        // Label pill
        const label = 'Entry: ' + entry + '¢';
        c.font = 'bold 10px system-ui, sans-serif';
        const tw = c.measureText(label).width;
        const px = 6, py = 3;
        const lx = area.right - tw - px * 2 - 4;
        const ly = yPos - 10 - py;
        c.fillStyle = 'rgba(251, 191, 36, 0.15)';
        c.strokeStyle = 'rgba(251, 191, 36, 0.4)';
        c.lineWidth = 1;
        c.beginPath();
        c.roundRect(lx, ly, tw + px * 2, 16 + py, 4);
        c.fill();
        c.stroke();
        c.fillStyle = '#fbbf24';
        c.textAlign = 'left';
        c.textBaseline = 'middle';
        c.fillText(label, lx + px, ly + 8 + py / 2);
        c.restore();
      }
    },
    {
      // Current price dot + "Now" label
      id: 'currentPrice',
      afterDatasetsDraw(chart) {
        const meta = chart.getDatasetMeta(0);
        if (meta.data.length === 0) return;
        const last = meta.data[meta.data.length - 1];
        if (!last) return;
        const c = chart.ctx;
        const idx = chart.canvas.id.split('-')[1];
        const bid = positionData[idx]?.bid || 0;
        const winning = bid >= entry;
        const color = winning ? '#10b981' : '#ef4444';
        c.save();
        // Glow
        c.beginPath();
        c.arc(last.x, last.y, 10, 0, Math.PI * 2);
        c.fillStyle = winning ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)';
        c.fill();
        // Outer ring
        c.beginPath();
        c.arc(last.x, last.y, 6, 0, Math.PI * 2);
        c.fillStyle = winning ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)';
        c.fill();
        // Inner dot
        c.beginPath();
        c.arc(last.x, last.y, 3, 0, Math.PI * 2);
        c.fillStyle = color;
        c.fill();
        // "Now" label
        c.fillStyle = '#64748b';
        c.font = '9px system-ui, sans-serif';
        c.textAlign = 'center';
        c.fillText('Now', last.x, chart.chartArea.bottom + 14);
        // Current price label next to dot
        c.fillStyle = color;
        c.font = 'bold 11px system-ui, sans-serif';
        c.textAlign = 'left';
        c.fillText(bid + '¢', last.x + 10, last.y + 4);
        c.restore();
      }
    }]
  });

  charts[index] = chart;
}

// Initialize all charts
positionData.forEach((data, i) => createChart(i, data));

// ---------- Live refresh ----------
let refreshTimer;

async function refreshPrices() {
  try {
    const resp = await fetch('/api/charts/prices');
    const json = await resp.json();
    if (!json.ok) return;

    document.getElementById('update-status').textContent =
      'Updated ' + new Date().toLocaleTimeString();

    json.positions.forEach(pos => {
      const card = document.querySelector(
        `[data-ticker="${pos.ticker}"][data-side="${pos.side}"]`
      );
      if (!card) return;
      const idx = parseInt(card.dataset.index);
      const entry = pos.entry_cents;
      const isWinning = pos.current_bid >= entry;
      const lineColor = isWinning ? '#10b981' : '#ef4444';

      // Update positionData
      positionData[idx].bid = pos.current_bid;
      positionData[idx].ask = pos.current_ask;
      positionData[idx].history = pos.history;
      positionData[idx].closeTime = pos.close_time;
      positionData[idx].bidHigh = pos.bid_high;
      positionData[idx].bidLow = pos.bid_low;

      // Update border color
      card.className = card.className
        .replace(/border-(emerald|red)-900\/40/g, '')
        .trim() + (isWinning ? ' border-emerald-900/40' : ' border-red-900/40');

      // Update P&L display
      const pnlEl = card.querySelector('.pnl-display');
      const pnlVal = pos.unrealized_cents / 100;
      pnlEl.textContent = (pnlVal >= 0 ? '+' : '-') + '$' + Math.abs(pnlVal).toFixed(2);
      pnlEl.className = 'text-xl font-bold pnl-display ' +
        (isWinning ? 'text-emerald-400' : 'text-red-400');

      // Update arrow
      const arrowEl = card.querySelector('.direction-arrow');
      if (arrowEl) {
        arrowEl.textContent = isWinning ? '▲' : '▼';
        arrowEl.className = 'text-lg direction-arrow ' + (isWinning ? 'text-emerald-400' : 'text-red-400');
      }

      // Update % change
      const pctEl = card.querySelector('.pct-display');
      if (pctEl && entry > 0) {
        const pct = ((pos.current_bid - entry) / entry * 100).toFixed(1);
        pctEl.textContent = (pct >= 0 ? '+' : '') + pct + '%';
        pctEl.className = 'text-xs font-medium pct-display ' +
          (isWinning ? 'text-emerald-400/70' : 'text-red-400/70');
      }

      // Update bid/ask display
      const bidAskEl = card.querySelector('.bid-ask-display');
      bidAskEl.innerHTML =
        '<span class="' + (isWinning ? 'text-emerald-400' : 'text-red-400') + '">' + pos.current_bid + '&cent;</span>' +
        '<span class="text-slate-600">/</span>' +
        '<span class="text-slate-400">' + pos.current_ask + '&cent;</span>';

      // Update change per contract
      const perEl = card.querySelector('.per-contract-display');
      const perVal = pos.current_bid - entry;
      perEl.textContent = (perVal >= 0 ? '+' : '') + perVal + '¢';
      perEl.className = 'text-sm font-bold per-contract-display ' +
        (isWinning ? 'text-emerald-400' : 'text-red-400');

      // Update high/low
      const hlEl = card.querySelector('.high-low-display');
      if (hlEl) {
        hlEl.innerHTML =
          '<span class="text-emerald-400/70">' + pos.bid_high + '&cent;</span>' +
          '<span class="text-slate-600">/</span>' +
          '<span class="text-red-400/70">' + pos.bid_low + '&cent;</span>';
      }

      // Update close time
      const timeEl = card.querySelector('.time-left-display');
      timeEl.dataset.closeTime = pos.close_time;

      // Update chart
      const chart = charts[idx];
      if (!chart) return;

      const bidPoints = pos.history.map(h => ({
        x: historyTime(h), y: h.bid_cents
      }));
      if (pos.current_bid > 0) bidPoints.push({ x: new Date(), y: pos.current_bid });

      const askPoints = pos.history.map(h => ({
        x: historyTime(h), y: h.ask_cents
      }));
      if (pos.current_ask > 0) askPoints.push({ x: new Date(), y: pos.current_ask });

      // Entry line spanning full range
      const entryLineData = [];
      if (bidPoints.length > 0) {
        entryLineData.push({ x: bidPoints[0].x, y: entry });
        entryLineData.push({ x: bidPoints[bidPoints.length - 1].x, y: entry });
      }

      // Update datasets
      chart.data.datasets[0].data = bidPoints;
      chart.data.datasets[0].borderColor = lineColor;
      chart.data.datasets[0].backgroundColor = isWinning ? 'rgba(16, 185, 129, 0.12)' : 'rgba(239, 68, 68, 0.12)';
      chart.data.datasets[0].pointBackgroundColor = lineColor;
      chart.data.datasets[0].pointBorderColor = isWinning ? 'rgba(16, 185, 129, 0.4)' : 'rgba(239, 68, 68, 0.4)';
      chart.data.datasets[1].data = askPoints;
      chart.data.datasets[2].data = entryLineData;

      // Recalculate Y-axis
      const allP = bidPoints.map(p => p.y).concat(askPoints.map(p => p.y)).concat([entry]);
      chart.options.scales.y.min = Math.max(0, Math.min(...allP) - 3);
      chart.options.scales.y.max = Math.min(100, Math.max(...allP) + 3);

      chart.update('none');
    });

    updateTimers();
  } catch (e) {
    console.error('Chart refresh error:', e);
  }
}

refreshTimer = setInterval(refreshPrices, 60000);
</script>
{% endblock %}
